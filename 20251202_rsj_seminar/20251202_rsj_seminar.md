---
marp: true
---

<!-- footer: "2025年12月2日 RSJセミナー" -->

# 自律移動と最適制御

-大域計画, 障害物回避, 機械学習, 潜在空間, 伝統的な制御の統一的な理解のために-

千葉工業大学 上田 隆一

<br />

<span style="font-size:70%">This work is licensed under a </span>[<span style="font-size:70%">Creative Commons Attribution-ShareAlike 4.0 International License</span>](https://creativecommons.org/licenses/by-sa/4.0/).
![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)

---

<!-- paginate: true -->

## 今日やること

- 本日の話の動機（これだけで終わらないようにします）
- 探索問題と最適制御の接続
- ベルマン方程式とポントリャーギンの最大原理
- 潜在空間での制御
- その先

---

## この発表の動機: 「みんな仲良く」

- 自身の経験
    - 制御ゴリゴリの人と学習の人で会話が合わない
        - 同じはずなんだけどなあ・・・
    - 価値反復使ってたら「なんで学習でやらないんですか？」と質問された
        - 同じはずなんだけどなあ・・・
    - 制御をポントリャーギンの最大（最小）限理から考えている人とベルマン方程式から考えている人で会話が合わない
        - 同じはずなんだけどなあ・・・
- 自分の頭の中ではみんな同じ
    - 頭の中をさらけだして皆さんにお前はおかしいと叱ってもらいたい
    - もし今日の話に一理でもあるなら相互に理解が深まるはず


---

## 今日の話がうまくできるかどうか分からないので

- 考えはこの本の9章に書いてあります
    - 誰も9章まで辿り着いてないのではないか？
        - 青色の本でもオレンジ色の本でも同じ現象
    - お食事中の方すみません


![w:600](senden.png)

![bg right:30% 95%](robot_and_stats.jpg)


---

## 探索から制御問題へ


---

### 話の出発点: ロボットの計画問題（探索）

- 占有格子地図上にロボットの現在地から目的地まで線を引く
    - 次元が低く古典的な方法でも解ける
    - ダイクストラ、A*、RRT、...
        - いまだ現役
- 一方、移動ロボットや自動車を自律移動させることは難しい
    - 自己位置推定がずれる（今回は直接扱わず）、 障害物をうまく避けれない、・・・

$\qquad\qquad$![w:300](astar.gif)![w:300](rrt.gif)<span style="font-size:70%">図: [AtsushiSakai/PythonRobotics](https://github.com/AtsushiSakai/PythonRobotics)で作成</span>

---

### 一般的なアプローチ: 問題の分割

- 大域計画+諸問題の解決
    - 大域計画+障害物回避
- だいたいの場合、これで問題ない
    - 現場であれば問題が出たらまた潰せば良い
- 本当にこれで問題ない？
    - 理論上解決できないのか？
    - 根本から解決する方法はないのか？

<span style="color:red">$\Longrightarrow$問題を整理しましょう</span>

![bg right:35% 95%](avoidance.svg)

---

### 大域計画は制御問題のサブセット

- 制御の問題をシンプルに説明すると
    - 「現状の<span style="color:red">状態</span>がよくないので、理想の<span style="color:red">状態</span>に持っていきたい」
- 例（全部一緒じゃないですか）
    - 機械が振動している$\rightarrow$振動してない状態に戻したい
    - ライントレースのロボットがラインからずれた$\rightarrow$ライン中央に戻したい
    - <span style="color:red">今いるところは目的地じゃない$\rightarrow$目的地にいる状態に持っていきたい</span>
        - これが移動ロボットの大域計画の問題
    - 洗濯物が洗濯機の中に$\rightarrow$畳んで収納したい
        - <span style="font-size:80%">（※VLAは目的の状態を言葉から自律的に設定）</span>


---

### 状態と行動

- 制御: 理想の状態まで状態を遷移させていく
    - 状態: 状態の集合$\mathcal{X}$の要素$\boldsymbol{x}$
    - 理想の状態: 終端状態の集合$\mathcal{X}_\text{f}$の任意の要素$\boldsymbol{x}_\text{f}$
- 状態を遷移させるもの
    - 行動（制御指令）: $\boldsymbol{u}$
- 状態と行動の関係（とりあえず離散時間系で）
    - 決定論的: $\boldsymbol{x}' = \boldsymbol{f}(\boldsymbol{x}, \boldsymbol{u})$
    - 確率的: $\boldsymbol{x}' \sim p(\boldsymbol{x}' | \boldsymbol{x}, \boldsymbol{u})$
        - 注意: $\boldsymbol{x}$はこの定式化を満たすように定義しないといけない（マルコフ性等）
        - 場合によっては時刻も$\boldsymbol{x}$の要素にできる


![bg right:30% 100%](state_final_state.svg)


---

### 最適制御

- いろんな遷移方法があるので罰則をつけたほうがいい
    - 時間がかかりすぎる$\rightarrow$罰則
    - エネルギーを食いすぎる$\rightarrow$罰則
    - 危険$\rightarrow$罰則
- 罰則の与え方（評価関数）: $r(\boldsymbol{x}, \boldsymbol{u}, \boldsymbol{x}')$

---

### 大域計画を最適制御で解釈


---

### 大域計画は制御問題のサブセット

- 探索問題はなにを解いているか？
    - （直接的、あるいは間接的に）<span style="color:red">ゴールまでのコスト</span>を計算
        - コスト: 通常は時間や距離、ステップ数
            - 危険やロボットが汚れる箇所には時間、距離換算でペナルティー
- 解けた解の構造
    - 一本道
    - 各地点でコストが（直接的/間接的に）概算されている
    - 経路を進むとコストが下がる（経路上でのコストの大小関係が解けている）

![w:400](search.svg)

---

### 探索と制御（本発表の結論？）

- 各地点のコストの計算: 制御問題
- 最適制御問題
    - 状態空間と状態を考える

![bg right:30% 100%](optimal_control.svg)

---

### 最適制御問題が「解けていない」状態



---

### 探索が考えない問題

- ゴールに行くことは考えるが危険を避けることは制御レベルでは考えていない
- 環境の変化や不確かさ

「補足」が必要→補足で済むか？

---

### 探索で問題を解くと起こる問題

- 中央分離帯への衝突
    - 経路のチャタリング
    - メモしないこと、終端状態が正規のゴールしかないことで起こる
- 帯域計画と障害物回避の競合
    - $V$に停留点
    - 最大原理からの制御にも同じ側面

---

### 障害物との接触もゴール

---

中央分離帯ぶつかる問題集

価値関数だとぶつかるリスクも計算されている

どっちかを選ぶと引き込まれない

---

## LLMでの制御

- Robotics Transformer 2
   - ひとつずつ動きを出力
- とりあえず少しでも価値が上がる行動をしていれば最終的にタスクは達成できる

---
## その先の話

- 次元の呪いが克服されたら？
- 現在の計算機と性能のオーダーが違う計算機の登場

---

- コスト: 状態（位置）$\boldsymbol{x}$に対して$V(\boldsymbol{x})$

